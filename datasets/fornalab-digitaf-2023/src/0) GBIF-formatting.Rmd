---
title: "Darwin Core Mapping"
subtitle: "Landscape mitigation effects for improvements of biodiversity levels in tree rows next to cereal fields: DIGItal Tools to boost AgroForestry (DigitAF)"
author: "Jari Vandendendriessche (source: Sanne Govaert)"
date: "`r Sys.Date()`"
output: html_document
---

**For more information:**
https://github.com/inbo/fornalab-datasets/blob/main/datasets/fornalab-formica-wp1-vegetation/src/dwc_mapping.Rmd

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

# ----------------------------------
Load libraries:
# ----------------------------------

```{r message = FALSE}
library(readxl)
library(dplyr)
library(here)
library(digest)        
library(EML)
```

# ----------------------------------
# Read source data
# ----------------------------------

**columns needed:**
* Loc
* Type
* Sampletime
* Date
* LAT
* LON
* Method
* Spec
* Amount
* group
* Sex (M, F)
* Stage (empty, Ad, juv)
* Det

```{r}
pitfalls <- read.csv("Fieldwork data/Clean data/Obs.Pitfalls.csv") %>% 
  dplyr::select(Spec, Amount = Number, Loc, Type, LAT = lat, LON = lng, Sampletime = Trapnr, Method, Date = date, Det, Stage, Sex, Family, Order) %>%
  dplyr::mutate(Sampletime = ifelse(Sampletime == 1, "Spring - trap 1", "Spring - trap 2"))
transects <- read.csv("Fieldwork data/Clean data/Obs.Transects.csv") %>% 
  dplyr::select(Spec, Amount = Number, Loc, Type, LAT = lat, LON = lng, Sampletime, Method, Date = date, Det, Stage, Sex, Family, Order) %>%
  dplyr::mutate(Sampletime = ifelse(Sampletime == 1, "Spring", "Late summer"))
quadrats <- read.csv("Fieldwork data/Clean data/Obs.Plants.csv") %>% 
  dplyr::select(Spec, Amount = Number, Loc, Type, LAT = lat, LON = lng, Method, Date = date, Det, Stage, Sex, Family, Order) %>%
  dplyr::mutate(Sampletime = "Spring")
audiomoth_birds <- read.csv("Fieldwork data/Clean data/Obs.AudioMoths-birds.csv") %>% 
  dplyr::select(Spec, Loc, Type, LAT = lat, LON = lng, Method, Date = date, Det, Stage, Sex, Family, Order) %>%
  dplyr::mutate(Sampletime = "Spring", Amount = 1)
audiomoth_bats <- read.csv("Fieldwork data/Clean data/Obs.AudioMoths-bats.csv") %>% 
  dplyr::select(Spec, Loc, Type, LAT = lat, LON = lng, Method, Date = date, Det, Stage, Sex, Family, Order) %>%
  dplyr::mutate(Sampletime = "Spring", Amount = 1)
```

# ----------------------------------
# Create ID's and join data frames
# ----------------------------------

```{r}
my_data <- dplyr::bind_rows(pitfalls, transects, quadrats, audiomoth_birds, audiomoth_bats) %>%
  dplyr::mutate(TAG = paste(Loc, Type, Sampletime, sep = "_")) %>%
  dplyr::mutate(
    field = toupper(Type), # set in capital letters
    # Use 'event_id' and 'parent_event_id' to create unique event identifiers for plots
    event_id = paste("DIGITAF_BIODIVERSITY_FLEMISH_TREEROWS", "PLOT", Loc, Type, Sampletime, sep = ":"),
    parent_event_id = paste("DIGITAF_BIODIVERSITY_FLEMISH_TREEROWS", "LOCATION", Loc, sep = ":")
    )
my_data
```

# ----------------------------------
# Provide metadata
# ----------------------------------

```{r basic metadata}
short_name <- "DIGITAF_BIODIVERSITY_FLEMISH_TREEROWS"
title <- "Landscape mitigation effects for improvements of biodiversity levels in tree rows next to cereal fields: DIGItal Tools to boost AgroForestry (DigitAF)"
abstract <- c(
  "DIGITAF_BIODIVERSITY_FLEMISH_TREEROWS is a sampling event dataset published by Ghent University. It contains information on an exhaustive sampling event in 64 Flemish plots across 27 cereal fields. At each field, a plot was established in a bordering tree row (tree), in a treeless field margin (crtl) and in 10 fields we had the permission to sample in the field (crop). Fields were selected along a gradient of landscape composition acroos the available Flemish palette of landscapes. The dataset includes information on a biodiversity balance sampled as a snapshot with high taxonomic resolution. Mentioned groups were identified by any of our co-authors (unless otherwise indicated) to high taxonomic resolution (generally species level). Methods applied incorporated (i) 2 pitfall traps (14 days, Ø 9cm, d 11cm, autoantifreeze dilution, June) for beetles (Histeridae, Carabidae, Staphylinidae), spiders, ants, isopods, millipedes, centipedes and harvestmen, (ii) a transect walk (50m, 15', May-June & September) along the plot for lepidoptera, bees, wasps, flies and pollinating beetles, (iii) a vegetation quadrat of 10m² (2x5 or 1x10, depending on margin width, May-June) for plants and (iv) AudioMoth deployment between 05:15 CET-10:00 CET, 19:30-22:00 CET and 22:30-02:00 CET (48h, 1' per 15', 0-96 kHz, May-June) for birds and bats. Audiofiles were processed with BTO acoustic pipeline and the BirdNET analyzer with manual verification afterwards. Bat and bird data are presented in presence-absence (under one date, better resolution data can be requested), plant data in cover percentage and all other data in number of individuals caught. A metadata-file with parcel specifications will be published with the Zenodo-records of this dataset and can be requested through our contacts",
"We have released this dataset under a Creative Commons waiver. If you have any questions regarding this dataset, don't hesitate to contact us via the contact information provided in the metadata.",
"This sampling took place in the framework of the DIGItal Tools to help AgroForestry (<a href=\"https://digitaf.eu/\">DigitAF</a>) project (grant	agreement	no. 101059794), co-funded	by	the	European	Commission and the	European	Research	Agency,	within	the	Horizon	Europe	programme. This dataset was published with technical support provided by the Research Institute for Nature and Forest (INBO). We thank Marc van Kerckvoorde for the intensive identifications of carabids, staphylinids and histerids.")
```

```{r metadata}
publisher <- "Ghent University"
dataset_id = "" # First it's empty (since not yet registered on GBIF)
update_frequency <- "notPlanned"
type <- "Samplingevent"
metadata_language <- "en"
data_language <- "en"
data_license <- "https://creativecommons.org/publicdomain/zero/1.0/deed.en"
metadata_license <- "CC0 1.0"
creators <- list(   # If info not available: Add: NA_character_ 
  list(
    title = "Jari Vandendriessche",
    email = "jari.vandendriessche@ugent.be",
    organization = "Forest & Nature Lab, Ghent University",
    first_name = "Jari",
    last_name = "Vandendriessche",
    orcid = "0000-0003-3845-6655"
  ),
  list(
    title = "Maxime Eeraerts",
    email = "",
    organization = "Forest & Nature Lab, Ghent University", # Two affiliations: how to adress properly?
    first_name = "Maxime",
    last_name = "Eeraerts",
    orcid = "0000-0003-2739-9704"
  ),
  list(
    title = "Pieter De Frenne",
    email = "pieter.defrenne@ugent.be",
    organization = "Forest & Nature Lab, Ghent University",
    first_name = "Pieter",
    last_name = "De Frenne",
    orcid = "0000-0002-8613-0943"
  ),
  list(
    title = "Pallieter De Smedt",
    email = "pallieter.desmedt@ugent.be",
    organization = "Forest & Nature Lab, Ghent University",
    first_name = "Pallieter",
    last_name = "De Smedt",
    orcid = "0000-0002-3073-6751"
  ),
  list(
    title = "Augustijn De Ketelaere",
    email = "augustijn.deketelaere@ugent.be",
    organization = "",
    first_name = "Augustijn",
    last_name = "De Ketelaere",
    orcid = ""
  ),
  list(
    title = "Wouter Dekoninck",
    email = "wdekonick@naturalsciences.be",
    organization = "",
    first_name = "Wouter",
    last_name = "Dekoninck",
    orcid = ""
  ),
  list(
    title = "Jens D'Haeseleer",
    email = "jens.dhaeseleer@natuurpunt.be",
    organization = "",
    first_name = "Jens",
    last_name = "D'Haeseleer",
    orcid = ""
  ),
  list(
    title = "Jef Hendrix",
    email = "jef.hendrix@natuurpunt.be",
    organization = "",
    first_name = "Jef",
    last_name = "Hendrix",
    orcid = ""
  ),
  list(
    title = "Koen Lock",
    email = "",
    organization = "",
    first_name = "Koen",
    last_name = "Lock",
    orcid = ""
  ),
  list(
    title = "Astrid Van den Bossche",
    email = "astvdnbo.vandenbossche@ugent.be",
    organization = "Forest & Nature Lab, Ghent University",
    first_name = "Astrid",
    last_name = "Van den Bossche",
    orcid = ""
  ),
  list(
    title = "Bob Vandendriessche",
    email = "bob.vandendriessche@rlhp.be",
    organization = "",
    first_name = "Bob",
    last_name = "Vandendriessche",
    orcid = ""
  ),
  list(
    title = "Johan Van Keer",
    email = "",
    organization = "",
    first_name = "Johan",
    last_name = "Van Keer",
    orcid = ""
  ),
  #list(
  #  title = "Marc Van Kerckvoorde",
  #  email = "vankerckvoordemarc@gmail.com",
  #  organization = "",
  #  first_name = "Marc",
  #  last_name = "Van Kerckvoorde",
  #  orcid = ""
  #),
  list(
    title = "Luc Willems",
    email = "luc.willems@ugent.be",
    organization = "Forest & Nature Lab, Ghent University",
    first_name = "Luc",
    last_name = "Willems",
    orcid = ""
  ),
  list(
    title = "Kris Verheyen",
    email = "kris.verheyen@ugent.be",
    organization = "Forest & Nature Lab, Ghent University",
    first_name = "Kris",
    last_name = "Verheyen",
    orcid = "0000-0002-2067-9108"
  )
)
metadata_provider <- purrr::keep(creators, ~ .x$title %in% c("Jari Vandendriessche"))
contact <- purrr::keep(creators, ~ .x$title == "Jari Vandendriessche")
keywords <- c("biodiversity", "hedgerows", "agroforestry", "landscape", "beetles", "spiders", "ants", "lepidoptera", "bees", "wasps", "flies", "plants", "birds", "bats")
begin_date <-  min(raw_data$Date)
end_date <- max(raw_data$Date)
geographic_description <- "Flemish cereal fields"

##############################
# How to implement this???
#############################
taxonomic_coverage <- data.frame(
  scientificName = "Lepidoptera",
  taxonRank = "order"
)

taxonomic_description <- ""
references <- list(list(NA)) # Add references to articles using the data
```

```{r project metadata}
project_title <- "DIGItal Tools to boost AgroForestry (DigitAF)"
project_personnel <- purrr::keep(creators, ~ .x$title %in% c("Pieter De Frenne", "Kris Verheyen", "Jari Vandendriessche"))
project_abstract <- "Combining trees with crops or livestock on the same land has the potential to mitigate climate change. As a resilient agricultural practice, agroforestry (AF) can sequester carbon, preserve biodiversity and contribute to food security by diversifying agricultural production. The EU-funded DIGITAF project will promote AF systems. Specifically, it will co-develop digital tools tailored to the needs and concerns of AF target groups, including policy actors, practitioners and actors involved in the AF value chain. The project will implement six Living Labs in different countries to ensure an end-user-centred multi-actor approach. Bringing together 25 partners from 20 countries, DIGITAF will cover the entire AF value chain. It will contribute to farm sustainability, climate change mitigation, biodiversity preservation and soil conservation."
funding <- "Grant	agreement	no. 101059794, co-funded	by	the	European	Commission and the	European	Research	Agency,	within	the	Horizon	Europe	programme"
study_area_description <- "Europe"
design_description <- "Work package 3: Task 3.3: Co-develop, apply and verify a tool to quantify the biodiversity impact of agroforestry

The goal of WP3 Task3 is twofold:
- Quantifying biodiversity returns through agroforestry implementation with a digital tool for stakeholders
- Assembling biodiversity data to validate and incorporate in this tool

Why this research particularly?

Research is lacking on the biodiversity effects of agroforestry systems in temperate Europe, especially in relation to the surrounding landscape context. We try to fill this gap at least partially.

How?

27 cereal fields were selected along a gradient of landscape complexity throughout Flanders, each bordered with a hedgerow (tree row). We used the proxy of a tree row for agroforestry since mature agroforestry fields are rare."

logo_digitaf <- "D:/Users/jjovdndr/OneDrive - UGent/PhD DigitAf/Papers/Rproj/Paper 4/BiodivAF/www/Logos/DigitAF.png"
logo_fornalab <- "D:/Users/jjovdndr/OneDrive - UGent/PhD DigitAf/Papers/Rproj/Paper 4/BiodivAF/www/Logos/ForNaLab.png"
logo_ugent <- "D:/Users/jjovdndr/OneDrive - UGent/PhD DigitAf/Papers/Rproj/Paper 4/BiodivAF/www/Logos/UGent.png"
```

# ----------------------------------
# Darwin core transformation
# ----------------------------------

```{r dwc transformation}
event <- 
  my_data %>% 
  dplyr::mutate(
    .keep = "none",
    type = "Event",
    language = data_language,
    license = data_license, 
    rightsHolder = publisher,
    datasetID = dataset_id,
    institutionCode = "UGent", 
    datasetName = title,
    eventID = .data$event_id,
    parentEventID = .data$parent_event_id,
    eventDate = .data$Date,
    habitat = "Agricultural landscape",
    samplingProtocol = Method,
    country = "Belgium",
    decimalLatitude = .data$LAT,
    decimalLongitude = .data$LON,
    geodeticDatum = "EPSG:4326",
    coordinateUncertaintyInMeters = 5,
    eventRemarks = ""
  ) %>% 
  dplyr::distinct()

occurrence <-      # Repeat for different groups, depending on data: plants/animals, counts/presence-absence
  my_data %>% 
  dplyr::filter(!is.na(`Species (Scientific name)`)) %>% 
  dplyr::mutate(
    .keep = "none",
    language = data_language,
    type = "Event",
    license = data_license, 
    rightsHolder = publisher,
    datasetID = dataset_id,
    datasetName = title,
    identifiedBy = .data$Det,
    lifeStage = .data$Stage,
    lifeStage = ifelse(lifeStage == "Ad", "adult", lifeStage),
    lifeStage = ifelse(lifeStage == "juv", "juvenile", lifeStage),
    sex = .data$Sex,
    basisOfRecord = ifelse(.data$group %in% c("birds", "bats"), "MachineObservation", "PreservedSpecimen"),
    basisOfRecord = ifelse(.data$group %in% c("plants", "lepidoptera"), "HumanObservation", basisOfRecord),
    collectionCode = "DIGITAF",
    occurrenceID = .data$Occurrence_id,
    organismQuantity = .data$Amount, 
    organismQuantityType = ifelse(.data$group == "plants", "percentage cover", "individuals"),
    organismQuantityType = ifelse(.data$group %in% c("birds", "bats"), "presence/absence", organismQuantityType),
    occurrenceStatus = "present",
    eventID = .data$event_id, 
    scientificName = .data$Spec,
    kingdom = ifelse(.data$group == "plants", "Plantae", "Animalia"), 
    taxonRank = "species"
  )
```

# ----------------------------------
# Data quality check
# ----------------------------------

## Check classes of columns

```{r}
# Event
inherits(event$eventDate, "POSIXct")
check_event_numeric <- c(
  "decimalLatitude",
  "decimalLongitude"
)
purrr::map(event[, check_event_numeric], is.numeric)

# Occurrence
is.numeric(occurrence$organismQuantity)
```


## Check species names with GBIF backbone

```{r}
from_gbif <-
  occurrence %>%
  select(scientificName, taxonRank) %>%
  distinct %>%
  mutate(
    lookup = purrr::map2(
      scientificName,
      taxonRank,
      ~ rgbif::name_backbone(.x, rank = .y, kingdom = kingdom)
    ),
    .keep = "none"
  ) %>%
  dplyr::pull(lookup) %>%
  purrr::list_rbind()

## not matched exactly
no_exact_match <- unique(occurrence$scientificName)[!unique(occurrence$scientificName) %in% from_gbif$canonicalName]
from_gbif %>% filter(verbatim_name %in% no_exact_match)
```

# ----------------------------------
# Create metadata file (eml.xml)
# ----------------------------------

## Function to create contributors in EML format

```{r}
create_eml_contributors <- function(contributor_list) {
  purrr::map(contributor_list, ~ EML::set_responsibleParty(
    givenName = .$first_name,
    surName = .$last_name,
    organizationName = .$organization, # Discouraged by EML, but used by IPT
    email = .$email,
    userId = if (!is.na(.$orcid)) {
      list(directory = "https://orcid.org/", .$orcid)
    } else {
      NULL
    }
  ))
}
```

No changes necessary - all that needed adaptation is changed above

```{r EML initiation}
# Initiate EML
eml <- list(
  packageId = uuid::UUIDgenerate(),
  system = "uuid",
  dataset = list()
)
```

```{r EML dataset}
# Set short name and title
eml$dataset$shortName <- short_name
eml$dataset$title <- title

# Set abstract
eml$dataset$abstract$para <- abstract

# Set update frequency (requires a description, even if empty)
eml$dataset$maintenance <- list(
  description = list(para = ""),
  maintenanceUpdateFrequency = update_frequency
)

# Set creators
eml$dataset$creator <- create_eml_contributors(creators)

# Set contacts
eml$dataset$contact <- create_eml_contributors(contact)

# Set metadata providers
eml$dataset$metadataProvider <- create_eml_contributors(metadata_provider)

# Set keywords
eml$dataset$keywordSet <-
  list(
    list(
      keywordThesaurus = paste(
        "GBIF Dataset Type Vocabulary:",
        "http://rs.gbif.org/vocabulary/gbif/dataset_type_2015-07-10.xml"
      ),
      keyword = type
    ),
    list(
      keywordThesaurus = "n/a",
      keyword = keywords
    )
  )

# Set license
eml$dataset$intellectualRights$para <- metadata_license

# Set temporal and geographic coverage and geographicDescription
eml$dataset$coverage <-
  EML::set_coverage(
    beginDate = begin_date,
    endDate = end_date,
    geographicDescription = geographic_description,
    westBoundingCoordinate = min(event$decimalLongitude),
    southBoundingCoordinate = min(event$decimalLatitude),
    eastBoundingCoordinate = max(event$decimalLongitude),
    northBoundingCoordinate = max(event$decimalLatitude)
  )

# Set taxonomic coverage
eml$dataset$coverage$taxonomicCoverage <-
  list(
    taxonomicClassification =
      purrr::map(1:nrow(taxonomic_coverage), function(i) {
        current_row <- taxonomic_coverage[i, ]
        list(
          taxonRankName = current_row$taxonRank,
          taxonRankValue = current_row$scientificName
        )
      })
  )
eml$dataset$coverage$taxonomicCoverage$generalTaxonomicCoverage <- taxonomic_description

# Project
eml$dataset$project = list(
      title = project_title,
      abstract = list(para = project_abstract),
      funding = list(para = funding),
      studyAreaDescription = list(
        descriptor = list(
          descriptorValue = study_area_description,
          name = "generic",
          citableClassificationSystem = "false"
        )
      ),
      designDescription = list(
        description = list(para = design_description)
      ),
      personnel = create_eml_contributors(project_personnel)
    )

# -------------------------
# Metadataset
# -------------------------
eml$additionalMetadata = list(
    metadata = list(
      gbif = list(
        hierarchyLevel = "dataset",
        bibliography = list(
          citation = list(
            list(
              citation = references
            )
          )
        ),
        resourceLogoUrl = logo
      )))
```

```{r EML additional metadata}
# Bibliographic citations
eml$additionalMetadata$metadata$gbif$bibliography$citation <- references
```

# ----------------------------------
# Write data
# ----------------------------------

## Write darwin core

```{r write dwc}
dir_export <- here::here(directory, "processed")
 if (!dir.exists(dir_export)) {
    dir.create(dir_export, recursive = TRUE)
  }
readr::write_csv(event, here::here(dir_export, "event.csv"), na = "")
readr::write_csv(occurrence, here::here(dir_export, "occurrence.csv"), na = "")
```

```{r write EML}
EML::write_eml(eml, here::here(dir_export, "eml.xml"))
```